{% extends "layout/main.html" %}

{% block styles %}
    {{ super() }}
{% endblock %}

{% block sidebar_content %}
    <ul class="nav nav-pills flex-column">
        <li class="nav-item">
            <a class="nav-link sidebar-link" href="{{ url_for('main_bp.dashboard') }}">
                <i class="fas fa-home fa-fw"></i>
                Return to Dashboard
            </a>
        </li>
    <li class="nav-item">
            <a class="nav-link sidebar-link" href="{{ url_for('view_bp.view', project_id=dataset.project.id) }}">
                <i class="fas fa-sitemap fa-fw"></i>
                Return to Project
            </a>
        </li>
        <!-- Dataset banner -->
        <li class="nav-item">
            <a class="nav-link not-clickable active" href="#">
                <i class="fas fa-database fa-fw"></i>
                Dataset
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link current-section" href="{{ url_for('view_bp.view', dataset_id=dataset.id) }}">
                <i class="fas fa-chart-pie fa-fw"></i>
                Statistics
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link sidebar-link" href="{{ url_for('view_bp.raw', dataset_id=dataset.id) }}">
                <i class="fas fa-table fa-fw"></i>
                View raw
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link sidebar-link" href="{{ url_for('view_bp.history', dataset_id=dataset.id) }}">
                <i class="fas fa-history fa-fw"></i>
                View history
            </a>
        </li>
        {% include 'Data/View/operations.html' %}
    </ul>
{% endblock %}

{% block main_content %}
        <div class="card">
            <div class="card-header">
                <select id="stat-column-select" class="custom-select" style="width: 25%">
                    {% for column in columns %}
                        <option data-type="{{ column[1] }}">{{ column[0] }}</option>
                    {% endfor %}
                </select>
                <span id="type-display" class="float-right text-muted" style="margin-top: 9px">TYPE: BIGINT</span>
            </div>
            <div class="card-body">
                <div class="row-fluid">
                    <canvas id="stats-chart" height="auto"></canvas>
                </div>
                <hr/>
                <div class="row-fluid">
                    <table class="table table-bordered">
                        <thead class="text-muted">
                            <tr id="stat-names">
                        </thead>
                        <tbody>
                            <tr id="stat-values"></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
{% endblock %}

{% block modals %}
    {% include 'Data/View/operation_modals.html' %}
{% endblock %}

{% block scripts %}
    {{ super() }}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
    {% include 'Data/View/operations_scripts.html' %}
    <script type="text/javascript" charset="utf-8">
    {#  Can't move this to separate file because we need data provided by jinja template engine  #}

    var ctx = document.getElementById('stats-chart').getContext('2d');
    var chart;

    function update_stats(){
        $.getJSON(
            '{{ url_for('view_bp.get_column_info') }}',
            {
            dataset_id: '{{ dataset.id }}',
            column_name: $('#stat-column-select').val(),
            column_type: $('#stat-column-select option:selected').data('type')
            },
            function (data) {
                var name_section = $('#stat-names');
                var value_section = $('#stat-values');
                name_section.empty();
                value_section.empty();
                $.each(data, function(index, element) {
                    name_section.append('<td>' + index + '</td>');
                    value_section.append('<td>' + element + '</td>');
                });
                var type_display = $('#type-display');
                type_display.empty();
                type_display.append('TYPE: ' +  $('#stat-column-select option:selected').data('type'));
        });
    }

    function update_chart(){
        $.getJSON(
            '{{ url_for('view_bp.get_column_chart') }}',
            {
            dataset_id: '{{ dataset.id }}',
            column_name: $('#stat-column-select').val(),
            column_type: $('#stat-column-select option:selected').data('type')
            },
            function (data) {
                console.log(data);
                chart = new Chart(ctx, data);
        });
    }

    $(document).ready(function () {
        update_stats();
        update_chart();
    });

    $('#stat-column-select').on('change', function () {
        update_stats();
        chart.destroy();
        update_chart();
    });
    </script>
{% endblock %}
